name: Branches CI

on:
  # Trigger the workflow on push
  # but only for the non master branches
  push:
    branches-ignore:
      - master

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
        target: [ macosX64, iosX64, tvosX64, watchosX86 ]
        include:
          - os: ubuntu-latest
            target: jsNode
          - os: ubuntu-latest
            target: jsBrowser
          - os: ubuntu-latest
            target: jvm
          - os: ubuntu-latest
            target: linuxX64
          - os: windows-latest
            target: mingwX64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: 8
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: JS hack (TODO)
        if: matrix.target == 'jsNode' || matrix.target == 'jsBrowser'
        continue-on-error: true
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-core:${{ matrix.target }}Test
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Test rsocket-core module
        continue-on-error: true
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-core:${{ matrix.target }}Test
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Test rsocket-transport-local module
        continue-on-error: true
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-transport-local:${{ matrix.target }}Test
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Test rsocket-transport-ktor module
        if: matrix.target != 'mingwX64' && matrix.target != 'jsNode' && matrix.target != 'jsBrowser'
        continue-on-error: true
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: rsocket-transport-ktor:${{ matrix.target }}Test
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v2
        with:
          fail_on_failure: true
          check_name: ${{ matrix.target }} Test Report
          report_paths: '**/build/test-results/*Test/TEST-*.xml'
          github_token: ${{ secrets.GITHUB_TOKEN }}

  build:
    strategy:
      matrix:
        os: [ macos-latest, ubuntu-latest, windows-latest ]
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: 8
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Check full project compiles
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: build -PskipTests --scan --no-daemon
          wrapper-cache-enabled: false
          dependencies-cache-enabled: false
          configuration-cache-enabled: false

  publish:
    needs: [ build, test ]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-20.04, macos-latest, windows-latest ]
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: 8
      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Set BRANCH_NAME for publication
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
        shell: bash
      - name: Publish Packages to Artifactory (version x.y.z-${{ env.BRANCH_NAME }}-SNAPSHOT)
        uses: eskatos/gradle-command-action@v1
        with:
          arguments: artifactoryPublish -PbintrayUser=${{ secrets.bintrayUser }} -PbintrayKey=${{ secrets.bintrayKey }} -PversionSuffix=-${{ env.BRANCH_NAME }}-SNAPSHOT -PbuildNumber=${{ github.run_number }} --stacktrace --no-daemon
